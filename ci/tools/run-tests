#!/usr/bin/env bash

# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0

# A utility script to install the correct packages and run the tests.

set -euo pipefail

# Check if the script was called with exactly 1 argument
if [[ ${#} -ne 1 ]]; then
  echo "Error: This script requires exactly 1 argument. You provided ${#}"
  exit 1
fi
if [[ "${1}" != "bindings" && "${1}" != "core" && "${1}" != "pathfinder" ]]; then
  echo "Error: Invalid test module '${1}'. Must be 'bindings', 'core', or 'pathfinder'"
  exit 1
fi

test_module=${1}

# Install dependency groups first (uv sync manages the venv and removes
# packages it didn't install), then install pre-built wheels after.

if [[ "${test_module}" == "pathfinder" ]]; then
  pushd ./cuda_pathfinder
  echo "Installing pathfinder test deps and wheel"
  uv sync --frozen --package cuda-pathfinder --only-group test --no-install-project
  uv pip install ./*.whl
  echo "Running pathfinder tests with " \
      "LD:${CUDA_PATHFINDER_TEST_LOAD_NVIDIA_DYNAMIC_LIB_STRICTNESS} " \
      "FH:${CUDA_PATHFINDER_TEST_FIND_NVIDIA_HEADERS_STRICTNESS}"
  pytest -ra -s -v --durations=0 tests/ |& tee /tmp/pathfinder_test_log.txt
  # Report the number of "INFO test_" lines (including zero)
  # to support quick validations based on GHA log archives.
  line_count=$(awk '/^INFO test_/ {count++} END {print count+0}' /tmp/pathfinder_test_log.txt)
  echo "Number of \"INFO test_\" lines: $line_count"
  popd
elif [[ "${test_module}" == "bindings" ]]; then
  echo "Installing bindings test deps and wheels"
  pushd ./cuda_bindings
  uv sync --frozen --package cuda-pathfinder --only-group test --no-install-project
  uv sync --frozen --package cuda-bindings --only-group test --no-install-project
  uv pip install ./cuda_pathfinder/*.whl
  if [[ "${LOCAL_CTK}" == 1 ]]; then
    uv pip install "${CUDA_BINDINGS_ARTIFACTS_DIR}"/*.whl
  else
    uv pip install $(ls "${CUDA_BINDINGS_ARTIFACTS_DIR}"/*.whl)[all]
  fi
  echo "Running bindings tests"
  ${SANITIZER_CMD} pytest -rxXs -v --durations=0 --randomly-dont-reorganize tests/
  if [[ "${SKIP_CYTHON_TEST}" == 0 ]]; then
    ${SANITIZER_CMD} pytest -rxXs -v --durations=0 --randomly-dont-reorganize tests/cython
  fi
  popd
elif [[ "${test_module}" == "core" ]]; then
  TEST_CUDA_MAJOR="$(cut -d '.' -f 1 <<< ${CUDA_VER})"

  FREE_THREADING=""
  if python -c 'import sys; assert not sys._is_gil_enabled()' 2> /dev/null; then
    FREE_THREADING+="-ft"
  fi

  echo "Installing core test deps and wheels"
  pushd ./cuda_core
  uv sync --frozen --package cuda-pathfinder --only-group test --no-install-project
  uv sync --frozen --package cuda-bindings --only-group test --no-install-project
  uv sync --frozen --package cuda-core --only-group "test-cu${TEST_CUDA_MAJOR}${FREE_THREADING}" --no-install-project
  # Install all wheels after the last sync
  uv pip install ./cuda_pathfinder/*.whl
  if [[ "${SKIP_CUDA_BINDINGS_TEST}" == 1 ]]; then
    if [[ "${LOCAL_CTK}" == 1 ]]; then
      uv pip install "${CUDA_BINDINGS_ARTIFACTS_DIR}"/*.whl
    else
      uv pip install $(ls "${CUDA_BINDINGS_ARTIFACTS_DIR}"/*.whl)[all]
    fi
  else
    uv pip install "${CUDA_BINDINGS_ARTIFACTS_DIR}"/*.whl
  fi
  if [[ "${LOCAL_CTK}" == 1 ]]; then
    uv pip install "${CUDA_CORE_ARTIFACTS_DIR}"/*.whl
  else
    uv pip install $(ls "${CUDA_CORE_ARTIFACTS_DIR}"/*.whl)["cu${TEST_CUDA_MAJOR}"]
  fi
  echo "Running core tests"
  ${SANITIZER_CMD} pytest -rxXs -v --durations=0 --randomly-dont-reorganize tests/
  if [[ "${SKIP_CYTHON_TEST}" == 0 ]]; then
    ${SANITIZER_CMD} pytest -rxXs -v --durations=0 --randomly-dont-reorganize tests/cython
  fi
  popd
fi
