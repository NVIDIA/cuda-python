# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0

[workspace]
channels = ["conda-forge"]
platforms = ["linux-64", "linux-aarch64", "win-64"]

[dependencies]

[feature.cu12.dependencies]
[feature.cu13.dependencies]

[environments]
cu12 = { features = ["cu12"] }
cu13 = { features = ["cu13"] }

# Test Tasks
# Runs tests across all sub-packages: pathfinder → bindings → core (dependency order)
# Each sub-package has its own pixi.toml; the -e environment propagates via PIXI_ENVIRONMENT_NAME
#
# Usage: pixi run test | pixi run -e cu12 test | pixi run -e cu13 test
[target.linux.tasks.test-pathfinder]
args = [
    { arg = "flag", default = "--environment" },
    { arg = "env", default = "$PIXI_ENVIRONMENT_NAME" },
]
cmd = [
    "pixi",
    "run",
    "--manifest-path",
    "$PIXI_PROJECT_ROOT/cuda_pathfinder",
    "{{ flag }}",
    "{{ env }}",
    "test",
]

[target.linux.tasks.test-bindings]
args = [
    { arg = "flag", default = "--environment" },
    { arg = "env", default = "$PIXI_ENVIRONMENT_NAME" },
]
cmd = [
    "pixi",
    "run",
    "--manifest-path",
    "$PIXI_PROJECT_ROOT/cuda_bindings",
    "{{ flag }}",
    "{{ env }}",
    "test",
]

[target.linux.tasks.test-core]
args = [
    { arg = "flag", default = "--environment" },
    { arg = "env", default = "$PIXI_ENVIRONMENT_NAME" },
]
cmd = [
    "pixi",
    "run",
    "--manifest-path",
    "$PIXI_PROJECT_ROOT/cuda_core",
    "{{ flag }}",
    "{{ env }}",
    "test",
]

[target.linux.tasks.test]
args = [
    { arg = "flag", default = "--environment" },
    { arg = "env", default = "$PIXI_ENVIRONMENT_NAME" },
]
depends-on = [
    { task = "test-pathfinder", args = [
        "{{ flag }}",
        "{{ env }}",
    ] },
    { task = "test-bindings", args = [
        "{{ flag }}",
        "{{ env }}",
    ] },
    { task = "test-core", args = [
        "{{ flag }}",
        "{{ env }}",
    ] },
]
