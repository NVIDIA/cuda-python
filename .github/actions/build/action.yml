name: build

description: Build specified project

inputs:
  build-type:
    required: true
    type: string
    description: One of ci / release
  target-device:
    required: true
    type: string
  host-platform:
    required: true
    type: string
  upload-enabled:
    required: true
    type: boolean
  python-version:
    required: true
    type: string

runs:
  using: composite
  steps:
    - name: Set up Python ${{ inputs.python-version }}
      id: setup-python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Build cuda.core wheel
      uses: pypa/cibuildwheel@v2.22.0
      env:
        CIBW_BUILD: ${{ (inputs.python-version == '3.12' && 'cp312-manylinux*') ||
                        (inputs.python-version == '3.11' && 'cp311-manylinux*') ||
                        (inputs.python-version == '3.10' && 'cp310-manylinux*') ||
                        (inputs.python-version == '3.9' && 'cp39-manylinux*') }}
        CIBW_PROJECT_REQUIRES_PYTHON: ">=3.6"
        CIBW_ARCHS_LINUX: "native"
        CIBW_REPAIR_WHEEL_COMMAND: ""  # no repair
        CIBW_BUILD_VERBOSITY: 1
      with:
        package-dir: ./cuda_core/
        output-dir: ${{ env.CUDA_CORE_ARTIFACTS_DIR }}

    #- name: Display structure of the bindings artifacts folder (post build)
    #  shell: bash --noprofile --norc -xeuo pipefail {0}
    #  run: |
    #    sudo chown -R $(whoami) ${{ env.CUDA_BINDINGS_ARTIFACTS_DIR }}
    #    ls -lahR ${{ env.CUDA_BINDINGS_ARTIFACTS_DIR }}

    #- name: Upload bindings build artifacts
    #  uses: actions/upload-artifact@v4
    #  with:
    #    name: ${{ env.CUDA_BINDINGS_ARTIFACT_NAME }}
    #    path: ${{ env.CUDA_BINDINGS_ARTIFACTS_DIR }}

    - name: List the cuda.core artifacts directory
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        sudo chown -R $(whoami) ${{ env.CUDA_CORE_ARTIFACTS_DIR }}
        ls -lahR ${{ env.CUDA_CORE_ARTIFACTS_DIR }}

    - name: Upload cuda.core build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cuda_core*.whl
        path: ${{ env.CUDA_CORE_ARTIFACTS_DIR }}
