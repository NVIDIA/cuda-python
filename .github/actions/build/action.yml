name: build

description: Build specified project

inputs:
  build-type:
    required: true
    type: string
    description: One of ci / release
  target-device:
    required: true
    type: string
  host-platform:
    required: true
    type: string
  upload-enabled:
    required: true
    type: boolean
  python-version:
    required: true
    type: string

runs:
  using: composite
  steps:
    - name: Check out the repo
      uses: actions/checkout@v4

    - name: Build cuda.core wheel
      uses: pypa/cibuildwheel@v2.22.0
      env:
        CIBW_BUILD: cp312-*  # FIXME: Only build on CPython 3.12
        CIBW_ARCHS_LINUX: "auto"
        CIBW_REPAIR_WHEEL_COMMAND: ""  # no repair
      with:
        package-dir: ./cuda_core/
        output-dir: ${{ env.BINDINGS_ARTIFACTS_DIR }}

    - name: Display structure of the bindings artifacts folder (post build)
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        sudo chown -R $(whoami) ${{ env.BINDINGS_ARTIFACTS_DIR }}
        ls -lahR ${{ env.BINDINGS_ARTIFACTS_DIR }}

    - name: Upload bindings build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.BINDINGS_ARTIFACT_NAME }}
        path: ${{ env.BINDINGS_ARTIFACTS_DIR }}

    - name: Display structure of the core artifacts folder (post build)
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        sudo chown -R $(whoami) ${{ env.CORE_ARTIFACTS_DIR }}
        ls -lahR ${{ env.CORE_ARTIFACTS_DIR }}

    - name: Upload core build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.CORE_ARTIFACT_NAME }}
        path: ${{ env.CORE_ARTIFACTS_DIR }}
